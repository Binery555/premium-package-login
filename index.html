<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Deriv Signal + Trading Tool</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #0d0d0d; color: #fff; font-family: Arial; margin: 0; padding: 0; }
    .container { display: flex; gap: 20px; padding: 20px; }
    .left-panel { flex: 3; }
    .right-panel { flex: 1; }
    h1 { text-align: center; color: #0ff; }
    .chart-box, .history, .summary { background: #1a1a1a; border-radius: 10px; padding: 10px; margin-bottom: 20px; }
    canvas { width: 100% !important; height: 200px !important; }
    button { padding: 8px 12px; margin-right: 10px; background: #0ff; color: #000; border: none; border-radius: 5px; cursor: pointer; }
    #riseBtn { background: #0f0; } #fallBtn { background: #f00; } #cancelBtn { background: #444; color: #fff; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border: 1px solid #333; padding: 5px; text-align: center; }
    .win { background: #003300; color: #0f0; } .loss { background: #330000; color: #f00; }
    .entry { color: #0f0; } .stoploss { color: #f00; }
  </style>
</head>
<body>
<h1>ðŸ“ˆ Deriv Signal + Real Trading Tool</h1>
<div class="container">
  <div class="left-panel">
    <div class="chart-box">
      <canvas id="priceChart"></canvas>
    </div>
    <div class="chart-box">
      <canvas id="rsiChart"></canvas>
    </div>
    <div class="summary">
      <div id="signalStrength">Waiting for Signal...</div>
      <div id="stats">Total: 0 | Wins: 0 | Losses: 0 | Profit: $0.00</div>
    </div>
    <div class="history">
      <h3>ðŸ“œ Signal + Trade History</h3>
      <table>
        <thead><tr><th>Time</th><th>Market</th><th>Signal</th><th>Conf</th><th>Entry</th><th>SL</th><th>Dur</th><th>Status</th><th>Behavior</th></tr></thead>
        <tbody id="tradeHistory"></tbody>
      </table>
    </div>
  </div>

  <div class="right-panel">
    <label>Market:</label>
    <select id="marketSelect"></select><br/><br/>
    <label>Stake:</label>
    <select id="stake"><option>1</option><option>5</option><option>10</option></select><br/><br/>
    <label>Duration (min):</label>
    <select id="duration"><option>1</option><option>2</option><option>3</option></select><br/><br/>
    <button id="riseBtn">Rise</button>
    <button id="fallBtn">Fall</button>
    <button id="cancelBtn">Cancel</button><br/><br/>
    <div>ID: <strong id="loginId">-</strong></div>
    <div>Balance: <strong id="balance">-</strong> USD</div>
  </div>
</div>

<audio id="winSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
<audio id="lossSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>
<audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CONFIGURABLE REDIRECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const urlParams = new URLSearchParams(window.location.search);
const redirectUri = urlParams.get('redirect') || window.location.href;
const APP_ID = '81018';

// OAuth flow
(function handleOAuth() {
  const params = new URLSearchParams(window.location.search);
  if (params.has('token1') && params.has('acct1')) {
    localStorage.setItem('deriv_token', params.get('token1'));
    localStorage.setItem('deriv_loginid', params.get('acct1'));
    window.location.href = redirectUri;
    return;
  }
  const token = localStorage.getItem('deriv_token');
  if (!token) {
    window.location.href = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&redirect_uri=${encodeURIComponent(redirectUri)}`;
  }
})();

// Initialization
const markets = ['R_10','R_25','R_50','R_75','R_100','R_10_1s','R_25_1s'];
const marketSelect = document.getElementById('marketSelect');
markets.forEach(m => marketSelect.append(new Option(m,m)));
let ws, priceChart, rsiChart, priceData=[], rsiData=[], timeLabels=[], stats={total:0,wins:0,losses:0,profit:0}, contractMap={};

function initWebSocket() {
  ws = new WebSocket(`wss://ws.binaryws.com/websockets/v3?app_id=${APP_ID}`);
  ws.onopen = () => ws.send(JSON.stringify({ authorize: localStorage.getItem('deriv_token') }));
  ws.onmessage = ({ data }) => handleMessage(JSON.parse(data));
}

function handleMessage(msg) {
  if (msg.authorize) {
    document.getElementById('loginId').innerText = msg.authorize.loginid;
    document.getElementById('balance').innerText = parseFloat(msg.authorize.balance).toFixed(2);
    subscribeMarket(markets[0]);
  }
  if (msg.tick) onTick(msg.tick);
  if (msg.buy) onBuy(msg.buy);
  if (msg.proposal_open_contract) onContractUpdate(msg.proposal_open_contract);
}

// Tick processing
function onTick(tick) {
  const price = parseFloat(tick.quote);
  const time = new Date(tick.epoch*1000).toLocaleTimeString();
  priceData.push(price); timeLabels.push(time);
  if (priceData.length>100) { priceData.shift(); rsiData.shift(); timeLabels.shift(); }
  const rsi = calculateRSI(priceData);
  rsiData.push(rsi);
  updateCharts();
  autoAnalyze(price,rsi);
}

// Handle buy response
function onBuy(buy) {
  const id = buy.contract_id;
  const stake = buy.echo_req.parameters.amount;
  ws.send(JSON.stringify({ proposal_open_contract:1, contract_id:id, subscribe:1 }));
  addHistoryRow(id, buy.echo_req.parameters.contract_type, stake);
  stats.total++; updateStats();
}

// Contract status
function onContractUpdate(c) {
  const row = document.getElementById(`row-${c.contract_id}`);
  if (!row) return;
  const behaviorCell = document.getElementById(`behavior-${c.contract_id}`);
  const statusCell = document.getElementById(`status-${c.contract_id}`);
  if (c.status==='won') { row.className='win'; statusCell.textContent='WON'; stats.wins++; stats.profit+=parseFloat(c.profit); document.getElementById('winSound').play(); }
  else if (c.status==='lost') { row.className='loss'; statusCell.textContent='LOST'; stats.losses++; stats.profit+=parseFloat(c.profit); document.getElementById('lossSound').play(); }
  behaviorCell.textContent = `Entry: ${c.entry_spot_display_value}, Exit: ${c.current_spot_display_value}, PnL: $${c.profit}`;
  updateStats();
}

function addHistoryRow(id,type,stake) {
  const time=new Date().toLocaleTimeString();
  const html=`<tr id="row-${id}"><td>${time}</td><td>${marketSelect.value}</td><td>${type}</td><td>-</td><td class="entry">${stake}</td><td>-</td><td>${document.getElementById('duration').value}</td><td id="status-${id}">OPEN</td><td id="behavior-${id}">Waiting...</td></tr>`;
  document.getElementById('tradeHistory').insertAdjacentHTML('afterbegin',html);
}

function updateStats(){ document.getElementById('stats').textContent=`Total: ${stats.total} | Wins: ${stats.wins} | Losses: ${stats.losses} | Profit: $${stats.profit.toFixed(2)}`; }

function subscribeMarket(symbol){ ws.send(JSON.stringify({ forget_all:'ticks' })); ws.send(JSON.stringify({ ticks:symbol, subscribe:1 })); }

// Charts
function initCharts() {
  const pCtx=document.getElementById('priceChart').getContext('2d');
  priceChart=new Chart(pCtx,{type:'line',data:{labels:timeLabels,datasets:[{label:'Price',data:priceData,borderColor:'#0ff',pointRadius:0}]},options:{animation:false,scales:{x:{display:false}}}});
  const rCtx=document.getElementById('rsiChart').getContext('2d');
  rsiChart=new Chart(rCtx,{type:'line',data:{labels:timeLabels,datasets:[{label:'RSI',data:rsiData,borderColor:'#ff0',pointRadius:0}]},options:{animation:false,scales:{x:{display:false},y:{min:0,max:100}}}});
}

function updateCharts(){ priceChart.update(); rsiChart.update(); }

// RSI calc
function calculateRSI(data,period=14){ if(data.length<period+1)return 50; let gains=0,losses=0; for(let i=data.length-period;i<data.length;i++){ const diff=data[i]-data[i-1]; if(diff>0) gains+=diff; else losses-=diff;} const rs=gains/(losses||1); return 100-100/(1+rs); }

// Auto-analysis
function autoAnalyze(price,rsi){ const avg=priceData.slice(-5).reduce((a,b)=>a+b)/5; let signal=null; if(rsi<30&&price<avg) signal='CALL'; else if(rsi>70&&price>avg) signal='PUT'; if(signal){ document.getElementById('signalStrength').innerHTML=`ðŸ“Š Signal: ${signal}`; document.getElementById('alertSound').play(); trade(signal);} }

// Trade
function trade(type){ const stake=document.getElementById('stake').value; const duration=document.getElementById('duration').value; const buy={buy:1,price:stake,parameters:{amount:stake,basis:'stake',contract_type:type,currency:'USD',duration:duration,duration_unit:'m',symbol:marketSelect.value}}; ws.send(JSON.stringify(buy)); subscribeMarket(marketSelect.value);}  

document.getElementById('riseBtn').onclick=() => trade('CALL');
document.getElementById('fallBtn').onclick=() => trade('PUT');
document.getElementById('cancelBtn').onclick=() => ws.send(JSON.stringify({forget_all:'proposal_open_contract'}));

// Start
initCharts();
initWebSocket();
</script>

</body>
</html>
