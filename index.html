<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deriv Mini Trading Signal Tool</title>
  <style>
    body { background: #0d0d0d; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .container { padding: 20px; display: flex; gap: 20px; }
    .left-panel { flex: 3; }
    .right-panel { flex: 1; }
    h1 { text-align: center; color: #0ff; margin-bottom: 10px; }
    .controls { margin-bottom: 20px; }
    button { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; margin-right: 8px; }
    #riseBtn { background: #0f0; color: #000; }
    #fallBtn { background: #f00; color: #000; }
    select { padding: 6px; margin-right: 8px; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #333; padding: 5px; text-align: center; }
    .won { background-color: rgba(0,255,0,0.1); }
    .lost { background-color: rgba(255,0,0,0.1); }
  </style>
</head>
<body>
  <h1>Deriv Mini Trading Signal Tool</h1>
  <div class="container">
    <div class="left-panel">
      <div class="controls">
        <button id="startBtn">Start</button>
        <button id="stopBtn" disabled>Stop</button>
      </div>
      <div class="history-section">
        <h3>Trade History</h3>
        <table>
          <thead>
            <tr><th>Time</th><th>ID</th><th>Market</th><th>Type</th><th>Stake</th><th>Dur</th><th>Status</th></tr>
          </thead>
          <tbody id="tradeHistoryBody"></tbody>
        </table>
      </div>
    </div>
    <div class="right-panel">
      <div class="account-info">
        <span>Login ID: <strong id="loginId">–</strong></span><br>
        <span>Balance: <strong id="balance">–</strong> USD</span>
      </div>
      <label>Market:</label><br>
      <select id="marketSelect"></select><br>
      <label>Stake (USD):</label><br>
      <select id="stakeSelect"><option>1</option><option>5</option><option>10</option><option>25</option><option>50</option></select><br>
      <label>Duration (min):</label><br>
      <select id="durationSelect"><option>1</option><option>2</option><option>3</option><option>5</option><option>10</option></select><br>
      <button id="riseBtn" disabled>Rise</button>
      <button id="fallBtn" disabled>Fall</button>
    </div>
  </div>
  <script>
    const APP_ID = '81018';
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
    (function(){
      const p = new URLSearchParams(window.location.search);
      if(p.has('token1') && p.has('acct1')){
        localStorage.setItem('deriv_token', p.get('token1'));
        localStorage.setItem('deriv_loginid', p.get('acct1'));
        history.replaceState(null,'',REDIRECT_URI);
      }
    })();
    const API_TOKEN = localStorage.getItem('deriv_token');
    if(!API_TOKEN) window.location.href = OAUTH_URL;

    const WS_URL = `wss://ws.binaryws.com/websockets/v3?app_id=${APP_ID}`;
    const markets = ['R_10','R_25','R_50','R_75','R_100','R_10_1s','R_25_1s','R_50_1s','R_75_1s','R_100_1s'];
    let ws, subscriptionId;

    // Populate market dropdown
    const marketSelect = document.getElementById('marketSelect');
    markets.forEach(m => marketSelect.append(new Option(m, m)));

    function connect() {
      ws = new WebSocket(WS_URL);
      ws.onopen = () => {
        ws.send(JSON.stringify({ authorize: API_TOKEN }));
        subscribeTicks();
      };
      ws.onmessage = ({data}) => {
        const msg = JSON.parse(data);
        if(msg.authorize) {
          document.getElementById('loginId').innerText = msg.authorize.loginid;
          document.getElementById('balance').innerText = parseFloat(msg.authorize.balance).toFixed(2);
          document.getElementById('riseBtn').disabled = false;
          document.getElementById('fallBtn').disabled = false;
        }
        if(msg.buy) recordTrade(msg.buy);
        if(msg.proposal_open_contract) updateContract(msg.proposal_open_contract);
      };
    }

    // Subscribe to selected market ticks
    function subscribeTicks() {
      if(subscriptionId) ws.send(JSON.stringify({ forget: subscriptionId }));
      const symbol = marketSelect.value;
      ws.send(JSON.stringify({ ticks: symbol }));
      ws.onmessage = ({data}) => {
        const msg = JSON.parse(data);
        if(msg.tick) {/* could plot price here */}
        if(msg.buy) recordTrade(msg.buy);
        if(msg.proposal_open_contract) updateContract(msg.proposal_open_contract);
      };
    }

    marketSelect.onchange = () => subscribeTicks();

    function trade(type) {
      const stake = parseFloat(document.getElementById('stakeSelect').value);
      const duration = parseInt(document.getElementById('durationSelect').value, 10);
      const symbol = marketSelect.value;
      ws.send(JSON.stringify({ buy: {
        amount: stake,
        basis: 'stake',
        contract_type: type,
        currency: 'USD',
        duration: duration,
        duration_unit: 'm',
        symbol
      }, subscribe: 1 }));
    }

    function recordTrade(buy) {
      subscriptionId = buy.subscription.id;
      const now = new Date().toLocaleTimeString();
      const row = document.createElement('tr');
      row.id = `trade-${buy.contract_id}`;
      row.innerHTML = `
        <td>${now}</td>
        <td>${buy.contract_id}</td>
        <td>${buy.symbol}</td>
        <td>${buy.contract_type}</td>
        <td>${buy.amount.toFixed(2)}</td>
        <td>${buy.duration}</td>
        <td id="status-${buy.contract_id}">OPEN</td>
      `;
      document.getElementById('tradeHistoryBody').prepend(row);
    }

    function updateContract(info) {
      const cid = info.contract_id;
      const cell = document.getElementById(`status-${cid}`);
      if(cell) {
        const profit = info.profit;
        cell.innerText = profit >= 0 ? 'WON' : 'LOST';
        cell.parentElement.classList.add(profit >= 0 ? 'won' : 'lost');
        const balEl = document.getElementById('balance');
        let bal = parseFloat(balEl.innerText);
        bal += profit;
        balEl.innerText = bal.toFixed(2);
      }
    }

    document.getElementById('startBtn').onclick = () => {
      connect();
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
    };
    document.getElementById('stopBtn').onclick = () => {
      ws.close();
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      document.getElementById('riseBtn').disabled = true;
      document.getElementById('fallBtn').disabled = true;
    };
    document.getElementById('riseBtn').onclick = () => trade('CALL');
    document.getElementById('fallBtn').onclick = () => trade('PUT');
  </script>
</body>
</html>
