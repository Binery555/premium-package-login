<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volatility Index Live Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #fff;
    }

    .header {
      background-color: #1a1a1a;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid #333;
    }

    .header .title {
      font-weight: bold;
      font-size: 18px;
    }

    .chart-container {
      padding: 20px;
    }

    canvas {
      background-color: #181818;
      border: 1px solid #333;
      margin-bottom: 30px;
    }

    .dropdown {
      background-color: #1a1a1a;
      color: #fff;
      border: 1px solid #333;
      padding: 5px;
      font-size: 16px;
    }

    .price {
      font-size: 16px;
      margin-left: 20px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">ðŸ“ˆ Volatility Index Live Chart</div>
    <select id="indexSelector" class="dropdown">
      <option value="R_10">Volatility 10 (1s) Index</option>
      <option value="R_10">Volatility 10 Index</option>
      <option value="R_25">Volatility 25 (1s) Index</option>
      <option value="R_25">Volatility 25 Index</option>
      <option value="R_50">Volatility 50 (1s) Index</option>
      <option value="R_50">Volatility 50 Index</option>
      <option value="R_75">Volatility 75 (1s) Index</option>
      <option value="R_75">Volatility 75 Index</option>
      <option value="R_100" selected>Volatility 100 (1s) Index</option>
      <option value="R_100">Volatility 100 Index</option>
    </select>
  </div>

  <div class="chart-container">
    <canvas id="priceChart" height="150"></canvas>
  </div>

  <script>
    const token = "KsYMnJ8U7BJgklp";
    const maxPoints = 50;
    let priceData = [];
    let ws;
    let chart;
    let currentSymbol = "R_100";
    let subscriptionId;

    const ctx = document.getElementById("priceChart").getContext("2d");
    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Price",
          data: [],
          borderColor: "white",
          backgroundColor: "transparent",
          tension: 0.3
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: {
          x: { display: false },
          y: {
            display: true,
            grid: { color: "#222" },
            ticks: { color: "#999" }
          }
        }
      }
    });

    function connectWebSocket(symbol) {
      if (ws) ws.close(); // Clean up old socket

      ws = new WebSocket("wss://ws.derivws.com/websockets/v3?app_id=1089");

      ws.onopen = () => {
        ws.send(JSON.stringify({ authorize: token }));
      };

      ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);

        if (data.msg_type === "authorize") {
          subscribeToSymbol(symbol);
        } else if (data.msg_type === "tick") {
          const price = parseFloat(data.tick.quote);
          updateChart(price);
        }
      };
    }

    function subscribeToSymbol(symbol) {
      // Clear chart
      priceData = [];
      chart.data.labels = [];
      chart.data.datasets[0].data = [];

      const subRequest = {
        ticks: symbol,
        subscribe: 1
      };

      ws.send(JSON.stringify(subRequest));
    }

    function updateChart(price) {
      const now = new Date().toLocaleTimeString();

      if (priceData.length >= maxPoints) {
        priceData.shift();
        chart.data.labels.shift();
      }

      priceData.push(price);
      chart.data.labels.push(now);
      chart.data.datasets[0].data = [...priceData];
      chart.update();
    }

    // Dropdown Change Handler
    document.getElementById("indexSelector").addEventListener("change", (e) => {
      currentSymbol = e.target.value;
      connectWebSocket(currentSymbol);
    });

    // Initial load
    connectWebSocket(currentSymbol);
  </script>
</body>
</html>
